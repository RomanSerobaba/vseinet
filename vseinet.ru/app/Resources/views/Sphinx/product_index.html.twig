{% autoescape false %}
source product_index_plain_{{ geo_city_id }} : vseinet
{
    sql_field_string        = name
    sql_attr_uint           = category_id
    sql_attr_uint           = category_section_id
    sql_attr_uint           = brand_id
    sql_attr_multi          = uint supplier_id from ranged-main-query; SELECT sp.base_product_id AS id, sp.supplier_id FROM supplier_product sp INNER JOIN supplier s ON s.id = sp.supplier_id WHERE s.is_active = true AND sp.base_product_id BETWEEN $start AND $end GROUP BY sp.base_product_id, sp.supplier_id
    sql_attr_bool           = is_forbidden
    sql_attr_json           = details
    sql_attr_uint           = availability
    sql_attr_uint           = price
    sql_attr_uint           = price_order
    sql_attr_uint           = profit
    sql_attr_uint           = rating
    sql_attr_bool           = no_details
    sql_attr_bool           = no_image
    sql_attr_bool           = no_description
    sql_attr_bool           = no_manufacturer_link
    sql_attr_bool           = no_manual_link
    sql_attr_timestamp      = created_at
    sql_attr_bool           = killbill
    sql_query_range         = SELECT MIN(bp.id), MAX(bp.id) FROM base_product AS bp
    sql_range_step          = 5000
    sql_ranged_throttle     = 10
    sql_query               = {{ product_query|raw }}
}

index product_index_plain_{{ geo_city_id }}
{
    type                    = plain
    source                  = product_index_plain_{{ geo_city_id }}
    path                    = {{ workdir }}data/product_index_plain_{{ geo_city_id }}
    docinfo                 = extern
    morphology              = stem_en, lemmatize_ru
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
    #wordforms               = {{ workdir }}wordforms.txt
}

index product_index_rt_{{ geo_city_id }}
{
    type                    = rt
    rt_field                = name
    rt_attr_uint            = category_id
    rt_attr_uint            = category_section_id
    rt_attr_uint            = brand_id
    rt_attr_multi           = supplier_id
    rt_attr_bool            = is_forbidden
    rt_attr_json            = details
    rt_attr_uint            = availability
    rt_attr_uint            = price
    rt_attr_uint            = price_order
    rt_attr_uint            = profit
    rt_attr_uint            = rating
    rt_attr_bool            = no_details
    rt_attr_bool            = no_image
    rt_attr_bool            = no_description
    rt_attr_bool            = no_manufacturer_link
    rt_attr_bool            = no_manual_link
    rt_attr_timestamp       = created_at
    rt_attr_bool            = killbill
    path                    = {{ workdir }}data/product_index_rt_{{ geo_city_id }}
    docinfo                 = extern
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
    rt_mem_limit            = 1024M
    #wordforms               = {{ workdir }}wordforms.txt
}

index product_index_{{ geo_city_id }}
{
    type                    = distributed
    local                   = product_index_plain_{{ geo_city_id }}
    local                   = product_index_rt_{{ geo_city_id }}
}
{% endautoescape %}