{% autoescape false %}
source vseinet
{
    type                    = pgsql
    sql_host                = {{ pgsql.host }}
    sql_port                = {{ pgsql.port }}
    sql_db                  = {{ pgsql.dbname }}
    sql_user                = {{ pgsql.user }}
    sql_pass                = {{ pgsql.password }}
}

{% for product_index in product_indexes %}
{{ product_index }}
{% endfor %}

source category_index : vseinet
{
    sql_field_string        = name
    sql_attr_uint           = rating
    sql_attr_bool           = is_leaf
    sql_attr_bool           = killbill
    sql_query               = SELECT c.id, c.name, c.rating, CASE WHEN EXISTS (SELECT 1 FROM category AS cc WHERE cc.pid = c.id) THEN false ELSE true END AS is_leaf, false killbill FROM category AS c WHERE CASE WHEN (SELECT true FROM category_path AS cp WHERE cp.pid = 7707 AND cp.id = c.id) THEN false ELSE true END AND c.id > 0
}

index category_index
{
    source                  = category_index
    path                    = /var/lib/sphinx/pgsql/dev/category_index
    docinfo                 = extern
    morphology              = stem_en, lemmatize_ru
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
}

index category_index_rt
{
    type                    = rt
    rt_field                = name
    rt_attr_uint            = rating
    rt_attr_bool            = is_leaf
    rt_attr_bool            = killbill
    path                    = /var/lib/sphinx/pgsql/dev/category_index_rt
    docinfo                 = extern
    morphology              = stem_en, lemmatize_ru
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
}

index category
{
    type                    = distributed
    local                   = category_index
    local                   = category_index_rt
}

source supplier_product_index : vseinet
{
    sql_field_string        = code
    sql_attr_bool           = killbill
    sql_query_range         = SELECT MIN(sp.id), MAX(sp.id) FROM supplier_product sp INNER JOIN base_product bp ON bp.id = sp.base_product_id
    sql_range_step          = 30000
    sql_ranged_throttle     = 10
    sql_query               = SELECT sp.id, COALESCE(sp.code, sp.article) AS code, 0 AS killbill FROM supplier_product sp WHERE sp.id BETWEEN $start AND $end
}

index supplier_product_index
{
    source                  = supplier_product_index
    path                    = /var/lib/sphinx/pgsql/dev/supplier_product_index
    docinfo                 = extern
    morphology              = stem_en, lemmatize_ru
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
}

index supplier_product_index_rt
{
    type                    = rt
    rt_field                = code
    rt_attr_bool            = killbill
    path                    = /var/lib/sphinx/pgsql/dev/supplier_product_index_rt
    docinfo                 = extern
    morphology              = stem_en, lemmatize_ru
    min_infix_len           = 1
    min_word_len            = 1
    expand_keywords         = 1
    index_exact_words       = 1
    charset_table           = 0..9, A..Z->a..z, _, a..z, \
                            U+410..U+42F->U+430..U+44F, U+430..U+44F, U+401->U+0435, U+451->U+0435
}

index supplier_product
{
    type                    = distributed
    local                   = supplier_product_index
    local                   = supplier_product_index_rt
}

common
{
    lemmatizer_base         = /var/lib/sphinx/dict
}

indexer
{
    mem_limit               = 512M
}

searchd
{
    listen                  = {{sphinxql.port}}:mysql41
    log                     = /var/log/sphinx-pgsql-dev/searchd.log
    query_log               = /var/log/sphinx-pgsql-dev/query.log
    read_timeout            = 5
    max_children            = 300
    pid_file                = /var/run/sphinx-pgsql-dev/searchd.pid
    seamless_rotate         = 1
    preopen_indexes         = 1
    max_filters             = 256
    max_filter_values       = 4096
    unlink_old              = 1
    workers                 = threads
    binlog_path             = /var/lib/sphinx/pgsql/dev
}
{% endautoescape %}
