{% autoescape false %}
SELECT
    bp.id,
    bp.name,
    bp.category_id,
    COALESCE(bp.category_section_id, 0) AS category_section_id,
    bp.brand_id,
    CASE WHEN b.is_forbidden = TRUE THEN 1 ELSE 0 END AS is_forbidden,
    bpd.details,
    CASE
        WHEN p.product_availability_code = 'available' THEN 1
        WHEN p.product_availability_code IN ('in_transit', 'on_demand') THEN 2
        WHEN p.product_availability_code = 'awaiting' THEN 3
        ELSE 4
    END AS availability,
    ROUND(p.price / 100) AS price,
    CASE
        WHEN p.product_availability_code = 'available' THEN 1
        WHEN p.product_availability_code = 'in_transit' THEN 2
        WHEN p.product_availability_code = 'on_demand' THEN 3
        ELSE 4
    END AS price_order,
    p.profit,
    p.rating,
    CASE WHEN bpd.details IS NULL THEN 1 ELSE 0 END AS no_details,
    CASE WHEN bpi.id IS NULL THEN 1 ELSE 0 END AS no_image,
    CASE WHEN d.base_product_id IS NULL THEN 1 ELSE 0 END AS no_description,
    CASE WHEN COALESCE(bpd.manufacturer_link, '') = '' THEN 1 ELSE 0 END AS no_manufacturer_link,
    CASE WHEN COALESCE(bpd.manual_link, '') = '' THEN 1 ELSE 0 END AS no_manual_link,
    bp.created_at,
    0 AS killbill
FROM public.base_product AS bp
INNER JOIN public.base_product_data AS bpd ON bpd.base_product_id = bp.id
INNER JOIN aggregation.product_{{ geo_city_id }} AS p ON p.base_product_id = bp.id
LEFT OUTER JOIN base_product_image AS bpi ON bpi.base_product_id = bp.id AND bpi.sort_order = 1
LEFT OUTER JOIN base_product_description AS d ON d.base_product_id = bp.id
LEFT OUTER JOIN brand AS b ON b.id = bp.brand_id
WHERE bp.id BETWEEN $start AND $end
{% endautoescape %}